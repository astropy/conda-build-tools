# The language in this case has no bearing - we are going to be making use of "conda" for a
# python distribution for the scientific python stack.
language: c

os:
  - linux
  - osx

env:
    global:
        - TARGET_ARCH="x64"
        - CONDA_INSTALL_LOCN="${HOME}/conda"
        # Defines BINSTAR_TOKEN for astropy binstar channel
        - secure: "c/MXanxumEXl7l3vXv4Bx5cCm9RBvz4bBDrAbzSf9SjqS5Xq5Fv0jbetExNKzgjKzGQ3rv8HYhpOeVabNxHEmqqI8rOl79J/L1ba0XClTIBbkeO/rM2HS0LuS95FSvx4+eeAm6m+5xVBAJW3EXVssRt56T3y69JJD0+2pEtbUCT7I88fnb1llWRcnJsZh5sB8qppklYIc1qxofcw8EiCIBwY1wHGwQ/Jq4n6VutAjEnIUaK6cX7XuO8mvyhYEcg2gww4qcSiMkb/8KcXl9t8fSshLC1tNTwLhmA4dUo0Dbgow0xtUNqzy3L/TEWhfj9hBhGijexhMSrLwMTAEgIxPNiAsrHv3EOgX2sd/UXQo+vZ96V35apfRzJrojtGQhgIEUc36tCNfH3GcnX7jWZfaPySqohZAsj/RFrFPVkhW64VcdCAyhHc3UBTy3odmiiMYkln+cXJ/G3+CENDNeR/5uwKYQ1Ez79J1KrBIXrRYBsEAR6VCbRZ/mu/ea7cSzLeo9lIu4uyiLhLLvCua4U0/YkTJFebdpR+YNDyNVNuYVXU3XQCHRhi5DbSiNWDL1O0IxKDaTdir4dIx3+UOJCdkdJbIYH17k52u9of/52KYxssVeFMj62QjYgGiFwdTSjX7hClL3LfcF63HcJNoEu0hvtavF3qMyeduoQixrRX/Ks="
        - LATEST_GOOD_CONDA_BUILD="1.16.0"
        - BUILDER_PYTHON_VERSION="2"

    matrix:
        - CONDA_PY=27
          CONDA_NPY=19
          CONDA_BUILD_VERSION="=$LATEST_GOOD_CONDA_BUILD"
        - CONDA_PY=34
          CONDA_NPY=19
          CONDA_BUILD_VERSION="=$LATEST_GOOD_CONDA_BUILD"

matrix:
    fast_finish: true

    include:
        - os: linux
          env: CONDA_PY=27 CONDA_BUILD_VERSION=""  # selects latest version of conda-build

    allow_failures:
        # Canary in the coal mine to check out new versions of conda-build
        - env: CONDA_PY=27 CONDA_BUILD_VERSION=""  # selects latest version of conda-build

install:
    - python ./Obvious-CI/bootstrap-obvious-ci-and-miniconda.py ${CONDA_INSTALL_LOCN} ${TARGET_ARCH} $BUILDER_PYTHON_VERSION --without-obvci
    - export PATH=${CONDA_INSTALL_LOCN}/bin:$PATH
    - conda config --set always_yes true
    - conda update --quiet conda
    # Install a couple of dependencies we need for sure.
    - conda install --quiet --yes astropy anaconda-client jinja2 cython pycrypto
    - conda config --add channels astropy
    # Install custom version of conda-build for now (need to be able to pass
    # options to setup.py)
    - cd conda-build; python setup.py install; cd ..
    # Install obvious-ci; run 2to3 first if the build is python 3.
    - cd Obvious-CI; if [[ $BUILDER_PYTHON_VERSION == 3 ]]; then 2to3 -w .; fi; python setup.py install; cd ..
    # Add python build restrictions if needed
    - if defined PYTHON_BUILD_RESTRICTIONS; then PYTHON_RESTRICTIONS="--build-condition python $PYTHON_BUILD_RESTRICTIONS"; else PYTHON_RESTRICTIONS=""; fi

script:
    # Get ready to build.
    - python affiliate-builder/prepare_packages.py requirements.yml
    - if [[ -d recipes ]]; then obvci_conda_build_dir.py $PYTHON_RESTRICTIONS recipes astropy; fi
    # Right now fails happen immediately on trying to build.
    # Raise an exception if any of the packages are not built.
    # - python affiliate-builder/check_build_results.py

# Packages are now uploaded as they are built.
# after_success:
#     # Upload to binstar...this should probably be done as the bdists are built.
#     - python affiliate-builder/upload_bdists.py
